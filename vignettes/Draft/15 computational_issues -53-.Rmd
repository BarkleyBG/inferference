Vanderweele and Tchetgen Tchetgen proposed a new IPW estimator for estimating causal effects in the presence of interference. Heydrich-Perez implemented the estimator on a real dataset. Here we expose issues with computing the IPW estimator in practice.

The IPW estimator of the marginal effects weights outcomes for group $i$ with:
<<e w_i = \frac{\pi(\textbf{A}_i ; \alpha)}{Pr(\textbf{A}_i | \textbf{X}_i; \hat{\boldsymbol{\psi}}} = \frac{\prod_{j=1}^{n_i} \alpha^{A_{ij}} (1 - \alpha)^{1 - A_{ij}}}{ \int \prod_{j=1}^{n_i} h_{ij}^{A_{ij}} (1 - h_{ij}^{1 - A_{ij}}  f_b (b_i ; \psi_b) db_i  }
e>>
or equivalently,
<<e w_i = \left{ \int \prod_{j=1}^{n_i} (\frac{h_{ij}}{\alpha})^{A_{ij}} \left(\frac{(1 - h_{ij}}{1 - \alpha}\right)^{1 - A_{ij}}  f_b (b_i ; \psi_b) db_i  \right}^{-1} e>>

While mathematically equivalent, (1) and (2) may be computationally dissimilar. In the case of (1), the product term within the integral will be a product of values close to zero. In (2), the product is taken across values closer to one. Even for small group sizes, the values may not be computationally identical. 

Consider a toy example of $n = 4$ untreated (A = 0) units.  Suppose $h_ij = 0.2$ for each subject. To show the product terms are different depending on the order of operations, suppose there is no random effect.  With $\alpha = 0.4$, $w_i$ is exactly $0.31640625$. However, calculating this value in R using both (1) and (2) do not precisely return this value.  Using (1), difference between the exact value and the computed value is $5.55 x 10^{-17}$. Using (2), the difference is $1.66 x 10^{-16}$. While the discrepancy may appear inconsequential and 'normal' computation error in this simple case, we saw differences in weights as large as XX comparing weights computed using (1) and (2) for Heydrich-Perez's paper. As group size increases, the product in the denominator of  (1) evaluates as 0 more quickly. A value of zero not only violates the positivity assumption, but more importantly, leads to undefined values for the weights. This latter fact influenced the effect estimates reported in HP 2014. 

Of the 700 groups used in the main analysis of HP 2014, 15 contained over 1000 subjects. Since HP2014 used (1) to calculate weights, these 15 groups had missing values for weights for all the values of $\alpha$ considered and were excluded from computing the average IPW estimate. That is, rather than computing the average IPW across 700 groups, the average was taken across 685 groups, resulting in inflated effect estimates. 

Did not make substantive difference but….
we recommend…
both options available in rinterference…
(1) is faster; (2) is slower as it stuffs more operations under the integral.


